name: éƒ¨ç½²åˆ° Cloudflare Workers

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åº”ç”¨

    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # æš‚æ—¶ä½¿ç”¨npmç¼“å­˜ï¼Œç¨åä¼šåˆ‡æ¢åˆ°pnpm

      # å®‰è£… pnpm
      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
          run_install: false

      # é‡æ–°è®¾ç½® Node.js ç¯å¢ƒä»¥ä½¿ç”¨ pnpm ç¼“å­˜
      - name: é‡æ–°è®¾ç½® Node.js (ä½¿ç”¨ pnpm ç¼“å­˜)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # è·å– pnpm store ç›®å½•
      - name: è·å– pnpm store ç›®å½•
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # ç¼“å­˜ pnpm dependencies
      - name: è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # å®‰è£…ä¾èµ–
      - name: å®‰è£…ä¾èµ–
        run: |
          # å°è¯•ä½¿ç”¨frozen-lockfileï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å¸¸è§„å®‰è£…
          pnpm install --frozen-lockfile || pnpm install

      # ç±»å‹æ£€æŸ¥
      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: pnpm run typecheck

      # è¿è¡Œæµ‹è¯•
      - name: è¿è¡Œæµ‹è¯•
        run: pnpm run test:run

      # æ„å»ºåº”ç”¨
      - name: æ„å»ºåº”ç”¨
        run: pnpm run build

      # éƒ¨ç½²åˆ° Cloudflare Workers (ä»…åœ¨ main å’Œ develop åˆ†æ”¯)
      - name: éƒ¨ç½²åˆ° Cloudflare Workers
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

      # æ•°æ®åº“è¿ç§» (ä»…åœ¨éƒ¨ç½²æ—¶)
      - name: æ•°æ®åº“è¿ç§»
        if: github.event_name == 'push'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply ${{ github.ref == 'refs/heads/main' && 'nanobanana' || 'nanobanana-dev' }} --env ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

      # éƒ¨ç½²ç»“æœé€šçŸ¥
      - name: éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success() && github.event_name == 'push'
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆ!"
          echo "ğŸŒ ç¯å¢ƒ: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}"
          echo "ğŸ“¦ æäº¤: ${{ github.sha }}"